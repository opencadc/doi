# RAFTS Full Stack Deployment
# This is the main deployment file for running RAFTS with all services
#
# Usage:
#   Development:  docker compose --profile dev up --build
#   Production:   docker compose --profile prod up -d --build
#   With SSL:     docker compose --profile prod --profile ssl up -d --build
#
# Prerequisites:
#   - Copy .env.example to .env and configure
#   - For SSL: Ensure domain DNS points to this server

services:
  # =============================================================================
  # FRONTEND - Next.js Application
  # =============================================================================
  rafts-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_BASE_PATH=${NEXT_PUBLIC_BASE_PATH:-}
        - NEXT_PUBLIC_TURNSTILE_SITE_KEY=${NEXT_PUBLIC_TURNSTILE_SITE_KEY:-}
    container_name: rafts-frontend-nextjs
    ports:
      - '3080:8080'
    env_file:
      - .env
    environment:
      NODE_ENV: production
      PORT: '8080'
      # Internal service URLs (Docker networking)
      # Using non-prefixed vars for server actions (runtime)
      VALIDATOR_URL_XML: http://ades-validator-api:8000/validate-xml
      VALIDATOR_URL_PSV: http://ades-validator-api:8000/validate-psv
      VALIDATOR_URL_MPC: http://ades-validator-api:8000/validate-mpc
      NEXTAUTH_URL_INTERNAL: http://rafts-frontend:8080
    healthcheck:
      test: ['CMD', 'wget', '-q', '-O', '/dev/null', 'http://127.0.0.1:8080/api/health']
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - rafts-network
    depends_on:
      ades-validator-api:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    profiles:
      - dev
      - prod

  # =============================================================================
  # VALIDATOR API - ADES Validation Service
  # =============================================================================
  ades-validator-api:
    build:
      context: ./api/validator
      dockerfile: Dockerfile
    container_name: ades-validator-api
    ports:
      - '8000:8000'
    healthcheck:
      test: ['CMD', 'python', '-c', "import urllib.request; urllib.request.urlopen('http://localhost:8000/health-check')"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - rafts-network
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    profiles:
      - dev
      - prod

  # =============================================================================
  # NGINX - Reverse Proxy (Production)
  # =============================================================================
  nginx:
    image: nginx:alpine
    container_name: rafts-nginx
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./certbot/www:/var/www/certbot:ro
      - ./certbot/conf:/etc/letsencrypt:ro
    healthcheck:
      test: ['CMD', 'wget', '-q', '-O', '/dev/null', 'http://localhost/health']
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - rafts-network
    depends_on:
      rafts-frontend:
        condition: service_healthy
    profiles:
      - prod

  # =============================================================================
  # CERTBOT - SSL Certificate Management (Optional)
  # =============================================================================
  certbot:
    image: certbot/certbot
    container_name: rafts-certbot
    volumes:
      - ./certbot/www:/var/www/certbot
      - ./certbot/conf:/etc/letsencrypt
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"
    profiles:
      - ssl

networks:
  rafts-network:
    driver: bridge
